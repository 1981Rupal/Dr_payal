{% extends "base.html" %}

{% block title %}Calendar - Dr. Payal's Clinic CRM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-calendar3 me-2"></i>
            Appointment Calendar
        </h1>
        <p class="text-muted mb-0">View and manage appointments in calendar format</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('appointments.list_appointments') }}" class="btn btn-outline-primary">
            <i class="bi bi-list me-1"></i>
            List View
        </a>
        <a href="{{ url_for('appointments.add_appointment') }}" class="btn btn-success">
            <i class="bi bi-calendar-plus me-1"></i>
            New Appointment
        </a>
    </div>
</div>

<!-- Calendar Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-primary me-2" onclick="previousMonth()">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <h5 class="mb-0 me-2" id="currentMonth">{{ current_month }}</h5>
                    <button class="btn btn-outline-primary" onclick="nextMonth()">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="view" id="month-view" checked>
                    <label class="btn btn-outline-primary" for="month-view">Month</label>
                    <input type="radio" class="btn-check" name="view" id="week-view">
                    <label class="btn btn-outline-primary" for="week-view">Week</label>
                    <input type="radio" class="btn-check" name="view" id="day-view">
                    <label class="btn btn-outline-primary" for="day-view">Day</label>
                </div>
            </div>
            <div class="col-md-4">
                {% if current_user.role.value in ['super_admin', 'admin', 'staff'] %}
                <select class="form-select" id="doctorFilter" onchange="filterByDoctor()">
                    <option value="">All Doctors</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.full_name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Calendar -->
<div class="card">
    <div class="card-body p-0">
        <div id="calendar"></div>
    </div>
</div>

<!-- Legend -->
<div class="card mt-4">
    <div class="card-body">
        <h6 class="card-title">Legend</h6>
        <div class="row">
            <div class="col-md-3">
                <span class="badge bg-warning me-2">●</span>
                <small>Pending</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-success me-2">●</span>
                <small>Confirmed</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-info me-2">●</span>
                <small>Completed</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-danger me-2">●</span>
                <small>Emergency</small>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Details Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="appointmentDetails">
                <!-- Appointment details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editAppointmentBtn">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Appointment Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Add Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickAddForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quickPatient" class="form-label">Patient</label>
                        <select class="form-select" id="quickPatient" required>
                            <option value="">Select Patient</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.full_name }} - {{ patient.phone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quickDoctor" class="form-label">Doctor</label>
                        <select class="form-select" id="quickDoctor" required>
                            {% for doctor in doctors %}
                            <option value="{{ doctor.id }}">{{ doctor.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quickDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="quickDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quickTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="quickTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="quickType" class="form-label">Visit Type</label>
                        <select class="form-select" id="quickType" required>
                            <option value="clinic">Clinic Visit</option>
                            <option value="home">Home Visit</option>
                            <option value="online">Online Consultation</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quickReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="quickReason" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Schedule Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
    .fc-event {
        border: none !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
        font-size: 0.8rem !important;
    }
    
    .fc-event-pending {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }
    
    .fc-event-confirmed {
        background-color: #28a745 !important;
        color: white !important;
    }
    
    .fc-event-completed {
        background-color: #17a2b8 !important;
        color: white !important;
    }
    
    .fc-event-cancelled {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    .fc-event-emergency {
        background-color: #dc3545 !important;
        color: white !important;
        border: 2px solid #721c24 !important;
    }
    
    .fc-daygrid-day:hover {
        background-color: rgba(44, 90, 160, 0.05);
        cursor: pointer;
    }
    
    .fc-toolbar {
        margin-bottom: 1rem !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: var(--primary-color) !important;
    }
    
    .fc-button {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
    }
    
    .fc-button:hover {
        background-color: #1e3a5f !important;
        border-color: #1e3a5f !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    let calendar;
    let currentDoctorFilter = '';
    
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: function(info, successCallback, failureCallback) {
                fetch(`/api/appointments?start=${info.startStr}&end=${info.endStr}&doctor_id=${currentDoctorFilter}`)
                    .then(response => response.json())
                    .then(data => {
                        const events = data.appointments.map(appointment => ({
                            id: appointment.id,
                            title: `${appointment.patient.name} - ${appointment.doctor.name}`,
                            start: `${appointment.appointment_date}T${appointment.appointment_time}`,
                            end: `${appointment.appointment_date}T${addMinutes(appointment.appointment_time, appointment.duration_minutes)}`,
                            className: `fc-event-${appointment.status}${appointment.is_emergency ? ' fc-event-emergency' : ''}`,
                            extendedProps: {
                                appointment: appointment
                            }
                        }));
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error loading appointments:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                showAppointmentDetails(info.event.extendedProps.appointment);
            },
            dateClick: function(info) {
                openQuickAdd(info.dateStr);
            },
            eventDidMount: function(info) {
                // Add tooltip
                info.el.title = `${info.event.title}\nStatus: ${info.event.extendedProps.appointment.status}`;
            }
        });
        
        calendar.render();
        
        // View toggle handlers
        document.getElementById('month-view').addEventListener('change', function() {
            if (this.checked) calendar.changeView('dayGridMonth');
        });
        
        document.getElementById('week-view').addEventListener('change', function() {
            if (this.checked) calendar.changeView('timeGridWeek');
        });
        
        document.getElementById('day-view').addEventListener('change', function() {
            if (this.checked) calendar.changeView('timeGridDay');
        });
        
        // Quick add form handler
        document.getElementById('quickAddForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitQuickAdd();
        });
    });
    
    function previousMonth() {
        calendar.prev();
    }
    
    function nextMonth() {
        calendar.next();
    }
    
    function filterByDoctor() {
        currentDoctorFilter = document.getElementById('doctorFilter').value;
        calendar.refetchEvents();
    }
    
    function showAppointmentDetails(appointment) {
        const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        const detailsDiv = document.getElementById('appointmentDetails');
        
        detailsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Patient Information</h6>
                    <p><strong>Name:</strong> ${appointment.patient.name}</p>
                    <p><strong>Phone:</strong> ${appointment.patient.phone}</p>
                </div>
                <div class="col-md-6">
                    <h6>Appointment Details</h6>
                    <p><strong>Date:</strong> ${appointment.appointment_date}</p>
                    <p><strong>Time:</strong> ${appointment.appointment_time}</p>
                    <p><strong>Duration:</strong> ${appointment.duration_minutes} minutes</p>
                    <p><strong>Type:</strong> ${appointment.visit_type}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(appointment.status)}">${appointment.status}</span></p>
                </div>
            </div>
            ${appointment.reason ? `<div class="mt-3"><h6>Reason</h6><p>${appointment.reason}</p></div>` : ''}
            ${appointment.notes ? `<div class="mt-3"><h6>Notes</h6><p>${appointment.notes}</p></div>` : ''}
        `;
        
        document.getElementById('editAppointmentBtn').onclick = function() {
            window.location.href = `/appointments/${appointment.id}/edit`;
        };
        
        modal.show();
    }
    
    function openQuickAdd(dateStr) {
        document.getElementById('quickDate').value = dateStr;
        const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
        modal.show();
    }
    
    function submitQuickAdd() {
        const formData = {
            patient_id: document.getElementById('quickPatient').value,
            doctor_id: document.getElementById('quickDoctor').value,
            appointment_date: document.getElementById('quickDate').value,
            appointment_time: document.getElementById('quickTime').value,
            visit_type: document.getElementById('quickType').value,
            reason: document.getElementById('quickReason').value
        };
        
        fetch('/api/appointments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
                calendar.refetchEvents();
                alert('Appointment scheduled successfully!');
            } else {
                alert('Error scheduling appointment: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error scheduling appointment');
        });
    }
    
    function addMinutes(time, minutes) {
        const [hours, mins] = time.split(':').map(Number);
        const totalMinutes = hours * 60 + mins + minutes;
        const newHours = Math.floor(totalMinutes / 60);
        const newMins = totalMinutes % 60;
        return `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}`;
    }
    
    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'confirmed': 'success',
            'completed': 'info',
            'cancelled': 'secondary'
        };
        return colors[status] || 'primary';
    }
</script>
{% endblock %}
